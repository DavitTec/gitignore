#!/usr/bin/env bash
#==============================================================================:
# Script Name:    INSTALL
# Description:    Installs gitignore toolkit scripts and template library
# Author:         david
# Project:        gitignore
# Domain:         davit
# Author:         David Mullins
# License:        MIT
# Created:        2025-11-03 23:45:19
# UUID:           2bd8ec65-2e43-4fa8-9745-ec2b52d02c6c
# Version:        0.1.1
# Status:         stable
# Updated:        2025-11-03 21:15:00
# $Id: code-style v0.1.4 2025/11/04 18:00:00
# Style:          code-style v0.1.4
#==============================================================================:
#------------------------------------------------------------------------------:
# SHELLCHECK DIRECTIVES
#------------------------------------------------------------------------------:
# shellcheck disable=SC2155,SC1091,SC1090,SC2016
# Notes:
#   These warnings are disabled for structural templates.
#------------------------------------------------------------------------------:
#set -euo pipefail

#------------------------------------------------------------------------------
# Load .env
#------------------------------------------------------------------------------
if [[ -f .env ]]; then
    source .env
fi
VERSION=${VERSION:-0.1.0}
BIN_DIR=${BIN_DIR:-/opt/davit/bin}
LIB_DIR=${LIB_DIR:-/opt/davit/lib/gitignore}
ETC_DIR=${ETC_DIR:-/opt/davit/etc}

#------------------------------------------------------------------------------:
# Logging (fallback if davit-logger not present)
#------------------------------------------------------------------------------:
if ! source "/opt/davit/bin/davit-logger.sh" &>/dev/null; then
  log_info()  { printf "[INFO] %s\n" "$*"; }
  log_warn()  { printf "[WARN] %s\n" "$*" >&2; }
  log_error() { printf "[ERROR] %s\n" "$*" >&2; }
  log_success(){ printf "[OK] %s\n" "$*"; }
fi


#------------------------------------------------------------------------------
# Install scripts
#------------------------------------------------------------------------------
scripts=(gitignore.sh)
install_scripts() {
  mkdir -p "$BIN_DIR"
  for script in "${scripts[@]}"; do
    if [[ -f ./scripts/$script ]]; then
      cp "./scripts/$script" "$BIN_DIR/"
      chmod +x "$BIN_DIR/$script"
      log_info "Installed $script to $BIN_DIR"
    else
      log_warn "Script $script not found in ./scripts"
    fi
  done
}

#------------------------------------------------------------------------------
# Install templates
#------------------------------------------------------------------------------
install_templates() {
  if [[ ! -d ./lib/gitignore ]]; then
    log_error "Source templates directory ./lib/gitignore does not exist"
    exit 1
  fi

  mkdir -p "$LIB_DIR"
  for category in ./lib/gitignore/*; do
    if [[ -d "$category" ]]; then
      cat_name=$(basename "$category")
      mkdir -p "$LIB_DIR/$cat_name"
      cp -f "$category"/*.gitignore "$LIB_DIR/$cat_name/" 2>/dev/null || true
      log_info "Installed category $cat_name templates"
    fi
  done

  # Generate manifest
  ./scripts/manifest_generate.sh
}

#------------------------------------------------------------------------------
# Uninstall scripts
#------------------------------------------------------------------------------
uninstall_scripts() {
  for script in "${scripts[@]}"; do
    if [[ -f "$BIN_DIR/$script" ]]; then
      rm -f "$BIN_DIR/$script"
      log_info "Removed $script from $BIN_DIR"
    fi
  done
}

#------------------------------------------------------------------------------
# Uninstall templates
#------------------------------------------------------------------------------
uninstall_templates() {
  if [[ -d "$LIB_DIR" ]]; then
    rm -rf "$LIB_DIR"
    log_info "Removed templates directory $LIB_DIR"
  fi
  if [[ -f "$ETC_DIR/manifest.json" ]]; then
    rm -f "$ETC_DIR/manifest.json"
    log_info "Removed manifest $ETC_DIR/manifest.json"
  fi
}
#------------------------------------------------------------------------------
# USAGE 
#------------------------------------------------------------------------------
show_help() {
  cat << EOF
Usage: ./INSTALL [options]
Options:
  -i    Install scripts and templates
  -u    Uninstall scripts and templates
  -h    Show this help
EOF
}

#------------------------------------------------------------------------------
# Main
#------------------------------------------------------------------------------

# if [[ $# -eq 0 ]]; then
#   show_help
#   exit 0
# fi

main() {
 
  case "${1:-}" in
    -i|--install)
      log_info "Installing scripts and templates..."
      install_scripts
      install_templates
      ;;
    -u|--uninstall)
      log_info "Uninstalling scripts and templates..."
      uninstall_scripts
      uninstall_templates
      ;;
     -h|--help|"")
      show_help
      ;;
    *)
      log_error "Unknown option: $1"
      show_help
      exit 1
      ;;
  esac
}

# === ENTRY POINT =============================================================:
main "$@"
#==============================================================================:
# FOOTER
#------------------------------------------------------------------------------:
# TODO(INSTALL): [Func]: [F001]:Fix uninstall script function to check for script existence before removal.
# TODO(INSTALL): [Func]: [F002]:Add logging for uninstall script function.
# TODO(INSTALL): [Func]: [F003]:feat: add version check before installing scripts.
# TODO(INSTALL): [Doc]: [D001]:Update script header with more detailed description.
# TODO(INSTALL): [Func]: [F004]:feat: add to include bash alias insert/delete
# TODO(INSTALL): [Test]: [T001]:Create unit tests for install and uninstall functions.
# TODO(INSTALL): [Func]: [F005]:Enhance install script to handle dependencies.
# TODO(INSTALL): [Doc]: [D002]:docs: add README.md.
# TODO(INSTALL): [Lib]: [T001]:feat: Implement install src: ./lib/templates" for gitignore templates.
#==============================================================================:



